{% extends "app/base_site.html" %}

{% block title %} Pesaje Compra {% endblock title %}

{% block stylesheets %}
  {{ block.super }}
  <link href="/static/vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
  <link href="/static/vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
  <link href="/static/vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
  <link href="/static/vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
  <link href="/static/vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
  <!--plugin autocompletado -->
  <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
{% endblock stylesheets %}

{% block content %}
  <div class="right_col" role="main">

    <div class="row">
      <!-- form para el ingreso de los datos de una nueva compra -->
      <div class="clearfix"></div>

      <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
          <div class="x_title">
            <h2>Pesaje Compra de Maiz</h2>
            <div class="clearfix"></div>
          </div> 
          <div class="x_content">
                       
             <!-- form para el ingreso de los datos de una nueva compra -->
             <div class="form-horizontal form-label-left ">
              <div class="form-group">
                <label class="control-label col-md-2 col-sm-1 col-xs-12">Productor:</label>
                <div class="col-md-4 col-sm-4 col-xs-12">
                  <div class="input-group">
                    <input type="text" name="productor" id="productor" class="form-control" value="{{ productor }}">
                    <span class="input-group-btn">
                      <button id="btnLimpiarP" type="button" class="btn btn-danger"><i class="fa fa-times"></i></button>
                    </span>
                  </div>                  
                </div>

                <div class="form-group">
                  <label class="control-label col-md-2 col-sm-2 col-xs-12">Observación:</label>
                  <div class="col-md-4 col-sm-5 col-xs-12">
                    <textarea id="observacion" class="form-control" rows="2" placeholder="..."></textarea>
                  </div>
                </div>
              </div>                      
            </div>
            <div class="divider-dashed"></div>
          </div>
 
          <div class="form-horizontal form-label-left">
            <div class="form-group">
              <div class="col-md-4 col-sm-4 col-xs-12 form-group has-feedback">
                <input id="peso_bruto" type="number" class="form-control has-feedback-left" placeholder="Peso Bruto" min=0>
                <span class="fa fa-bus form-control-feedback left" aria-hidden="true"></span>
              </div>
              <div class="col-md-4 col-sm-4 col-xs-12 form-group has-feedback">
                <input id="peso_tara" type="number" class="form-control" placeholder="Peso Tara" min=0>

                <span class="fa fa-bus form-control-feedback right" aria-hidden="true"></span>
              </div>

              <div class="col-md-4 col-sm-4 col-xs-12 form-group has-feedback">
                <select id="factor_conversion" class="form-control">
                  <option value="default" selected disabled>Seleccione un valor</option>
                  <option>45.36</option>
                  <option>45.37</option>
                  <option>45.38</option>
                  <option>45.39</option>
                  <option>45.40</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <div class="col-md-2 col-sm-6 col-xs-12">
                <label class="control-label text-right">Peso Neto:</label>
              </div>
              <div class="col-md-2 col-sm-5 col-xs-12">
                <input id="peso_neto" type="number" class="form-control" readonly="readonly" value="0">
              </div>
              <div class="col-md-2 col-sm-6 col-xs-12">
                <label class="control-label 2">Peso Quintales:</label>
              </div>
              <div class="col-md-2 col-sm-5 col-xs-12">
                <input id="peso_quintales" type="number" class="form-control" readonly="readonly" value="0.00">
              </div>
              <div class="col-md-4 col-sm-12 col-xs-12">
                <div class="btn-group btn-group-justified">
                  <div class="btn-group" role="group">
                    <button id="btnCalcular" class="btn btn-primary"><span class="fa fa-calculator"></span>
                      Calcular</button>
                  </div>
                  <div class="btn-group" role="group">
                    <button id="btnAgregarPesaje" class="btn btn-success" disabled><span class="fa fa-plus"></span>
                      Agregar</button>
                  </div>
                  <div class="btn-group" role="group">
                    <button id="btnEditarPesaje" class="btn btn-warning" disabled><span class="fa fa-edit"></span>
                      Editar</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="divider-dashed"></div>
            <div class="form-group">
              <div class="col-md-12 col-sm-12 col-xs-12 text-center">
                <button id="btnGuardar" class="btn btn-success"><span class="fa fa-save"></span> Guardar Compra</button>
                <a class="btn btn-default" href="{% url 'gestion_compras' %}"><span class="fa fa-undo"></span>
                  Regresar</a>
              </div>
            </div>

          </div>
          <br>

          <div class="table-responsive">
            <table id="tabla_pesaje" class="table table-striped jambo_table bulk_action" style="width: 100%;">
              <thead>
                <tr class="headings"> 
                  <th class="column-title" scope="col" style="width: 7%;">Nro.</th> 
                  <th class="column-title text-center" scope="col" style="width: 18%;">Fecha </th>
                  <th class="column-title text-center"scope="col" style="width: 12.5%;">Peso Bruto </th>
                  <th class="column-title text-center"scope="col" style="width: 12.5%;">Peso Tara </th>
                  <th class="column-title text-center"scope="col" style="width: 12.5%;">Peso Neto </th>
                  <th class="column-title text-center"scope="col" style="width: 12.5%;">F. Conversión </th>
                  <th class="column-title text-center"scope="col" style="width: 12.5%;">Peso Quintales </th>
                  <th class="column-title text-center"scope="col" style="width: 12.5%;">Opciones</th>
                </tr>
              </thead>

              <tbody></tbody>
            </table>

          </div>

          <div class="form-group">
            <div class="col-md-9 col-md-offset-3 col-sm-offset-3 col-xs-offset-3">
              <label class="control-label col-md-1 col-sm-1 col-xs-1 ">Total</label>
              <div class="col-md-9 col-sm-9 col-xs-9">
                <label id="totalPesajes" class="control-label col-md-3 col-sm-3 col-xs-8">0.00</label>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- /Form para el ingreso de los datos de una empresa nueva -->
  
{% endblock content %}

{% block javascripts %}
  {{ block.super}}
  <!-- jquery.inputmask -->
  <script src="/static/vendors/jquery.inputmask/dist/min/jquery.inputmask.bundle.min.js"></script>

  <!-- Datatables --> 
  <script src="/static/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
  <script src="/static/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
   <!-- Datatables -->
  <script src="/static/vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
  <script src="/static/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
  <script src="/static/vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
  <script src="/static/vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
  <script src="/static/vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
  <script src="/static/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
  <script src="/static/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
  <script src="/static/vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
  <script src="/static/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
  <script src="/static/vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
  <script src="/static/vendors/jszip/dist/jszip.min.js"></script>
  <script src="/static/vendors/pdfmake/build/pdfmake.min.js"></script>
  <script src="/static/vendors/pdfmake/build/vfs_fonts.js"></script>
  <!-- plugin autocompletado -->
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script>
    $(function () {

      var productor = null; 
      var pesaje_editar = null;

      //** Declarar la tabla de Pesajes
      var tablaPesaje = $('#tabla_pesaje').DataTable({
        data: [],
        columnDefs: [
          {
            "targets": -1,
            "data": null,
            "defaultContent": "<div class='a-center'><button class='btn btn-info btn-xs tbEditarPesaje' title='Editar Pesaje'>" +
              "<i class='fa fa-pencil'></i></button><button class='btn btn-danger btn-xs tbEliminarPesaje' title='Eliminar Pesaje'>" +
              "<i class='fa fa-trash-o'></i></button></div>"
          },
          {
            targets: [6],
            class: 'text-center',
            render: function (data, type, row) {
              return '<span class="badge badge-default">' + data + '</span>';
              }
          },
          {
            targets: [1,2,3,4,5,7],
            class: 'text-center',
            
          },
        ],
        displayLength: 5,
        columns: [
          { "data": null }, //Contador de filas
          { "data": "fecha" },
          { "data": "pesoBruto" },
          { "data": "pesoTara" },
          { "data": "pesoNeto" },
          { "data": "factorConversion" },
          { "data": "pesoQuintales" },
          { "data": null }, //Botones editar y eliminar
        ],
        language: {
          "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
        }
      });

      //** Contador de Pesajes
      tablaPesaje.on('order.dt search.dt', function () {
        tablaPesaje.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
          cell.innerHTML = i + 1;
        });
      }).draw();

      
      //** Calcular el Pesaje 
      $("#btnCalcular").on('click', function () {
        if ($('#factor_conversion').val() != null &&  $('#peso_bruto').val().length != 0  &&  $('#peso_tara').val().length != 0 ) { // Si no se selecciona un factor
          let pesoNeto = calcularPesoNeto();
          if(pesoNeto < 0){
            $("#btnAgregarPesaje").attr("disabled", true);
            swal("Warning", "¡Datos ingresado para el calculo de suma incorrecto!", "warning"); 
          } else if (pesaje_editar != null) { //Si es una edición de Pesaje
            $("#btnEditarPesaje").attr("disabled", false);
            $('#peso_neto').val(pesoNeto);
            $('#peso_quintales').val(calcularPesoQuintales(pesoNeto));     
          } else if(pesoNeto > 0 ){
            $("#btnAgregarPesaje").attr("disabled", false);
            $('#peso_neto').val(pesoNeto);
            $('#peso_quintales').val(calcularPesoQuintales(pesoNeto));     
          }          
        } else {          
          swal("Warning", "¡Debe ingresar todos los campos de pesaje!", "warning");
        }
      });

      //** Agregar un nuevo Pesaje a la tabla
      $('#btnAgregarPesaje').on('click', function () {
        if($('#peso_neto').val() > 0  &&  $('#peso_bruto').val() > 0 && $('#peso_tara').val() > 0 ){
          let pesajeNuevo = convertPesajeToJson(new Date().toLocaleString(), $('#peso_bruto').val(), $("#peso_tara").val(),
          $('#peso_neto').val(), $('#factor_conversion').val(), $('#peso_quintales').val());
          tablaPesaje.rows.add(pesajeNuevo).draw(false);
          $(this).attr("disabled", true);
          $("#totalPesajes").text(calcularTotalPesaje());
          limpiarCamposCalculo();
        }else {
          swal("Warning", "¡Valores ingresados son incorrectos2!", "warning");
        } 
      });
      
      //** Editar un Pesaje de la tabla
      $('#btnEditarPesaje').on('click', function () {
        pesaje_editar.remove().draw(false);
        pesaje_editar = null;
        
        let pesajeEditado = convertPesajeToJson(new Date().toLocaleString(), $('#peso_bruto').val(), $("#peso_tara").val(),
          $('#peso_neto').val(), $('#factor_conversion').val(), $('#peso_quintales').val());
        tablaPesaje.rows.add(pesajeEditado).draw(false);

        $(this).attr("disabled", true);
        $("#totalPesajes").text(calcularTotalPesaje());
        limpiarCamposCalculo();

        swal("Success", "¡Pesaje editado correctamente!", "success");
      });

      //** autocompletado de los productores
      $("#productor").autocomplete({
        source: function(request,response){
          $.ajax({         
            url: "{% url 'buscar_productor_autocomplete' %}",
            type: "POST",
            data: { 
              'action': 'autocomplete',
              'term': request.term
            },
            success: function (data) {
              response(data);
            },
            error: function () {
              console.log("Hubo un problema.");
            }
          });
        },
        delay: 500,
        minLength: 3,
        select: function( event, ui ) {
          productor = ui.item
          console.log(productor) 
        }    
      });
    
      //** Buscar y cargar Productor
      $("#btnBuscar").on('click', function () {
        $.ajax({
          data: {
            "nro_cedula": $('#nro_cedula').val()
          },
          url: "{% url 'buscar_productor' %}",
          type: "POST",
          success: function (data) {
            if (data.length > 0) { //Si data tiene registros
              productor = data[0];
              $("#nom_productor").val(productor.fields.nombres);
            } else {
              $("#nom_productor").val(""); //Borrar nombre del productor
              productor = null;
              swal("Productor no existe", "Intente nuevamente con otra cédula.", "error");
            }
          },
          error: function () {
            console.log("Hubo un problema.");
          }
        });
      });

      //** Eliminar un Pesaje de la tabla
      $('#tabla_pesaje tbody').on( 'click', '.tbEliminarPesaje', function () {
        let fila = tablaPesaje.row($(this).parents('tr'));
        fila.remove().draw(false);
        $("#totalPesajes").text(calcularTotalPesaje());

        swal("Success", "¡Pesaje eliminado correctamente!", "success");
      });

      //** Editar un Pesaje de la tabla
      $('#tabla_pesaje tbody').on( 'click', '.tbEditarPesaje', function () {
        pesaje_editar = tablaPesaje.row($(this).parents('tr'));
        let data_pesaje = pesaje_editar.data();
        
        //Cargar los datos de la tabla al formulario
        $('#peso_bruto').val(data_pesaje.pesoBruto);
        $('#peso_tara').val(data_pesaje.pesoTara);
        $("#factor_conversion").val(data_pesaje.factorConversion);
        $('#peso_neto').val(data_pesaje.pesoNeto);
        $('#peso_quintales').val(data_pesaje.pesoQuintales);

        $("#btnEditarPesaje").attr("disabled", false);
        $("#totalPesajes").text(calcularTotalPesaje());
      });

      //** Guardar Pesajes
      $("#btnGuardar").on('click', function () {
        if (calcularTotalPesaje() > 0 && productor != null) { //Si hay Pesajes en la tabla y productor
          let datos_tabla = tablaPesaje.rows().data();
          let pesajes = $.makeArray();
          let pk_productor = productor.id;

          for (let i = 0; i < datos_tabla.length; i++) {
            pesajes.push(datos_tabla[i]);
          }
          $.ajax({
            data: {
              "pesajes":JSON.stringify(pesajes), "pk_productor":pk_productor, 
              "total_pesajes": $("#totalPesajes").text(), "observacion": $("#observacion").val()
            },
            url: "{% url 'guardar_pesajes' %}",
            type: "POST",
            success: function (data) {
              swal("Success", "¡Compra guardada correctamente!", "success");
              //Limpiar todos los campos y tabla
              limpiarCamposCompra();
            },
            error: function () {
              swal("Oops", "¡Ocurrió un problema!", "error");
            }
          });
        } else {
          swal("Warning", "No ha ingresado todos los datos.", "warning");
        }
      });

      //Limpiar campo de busqueda de responsable de transporte
      $('#btnLimpiarP').on('click', function () {
        $("#productor").val("");
        });

      function calcularPesoNeto() {
        let pesoBruto = parseInt($('#peso_bruto').val());
        let pesoTara = parseInt($('#peso_tara').val());
        return pesoBruto - pesoTara;
      }

      function calcularPesoQuintales(pesoNeto) {
        let factorConversion = parseFloat($("#factor_conversion").val());
        return (pesoNeto / factorConversion).toFixed(2);
      }

      //** Convertir el Pesaje en un Json
      function convertPesajeToJson(fecha, pesoBruto, pesoTara,
        pesoNeto, factorConversion, pesoQuintales) {
        return [{
          "fecha": fecha, "pesoBruto": pesoBruto, "pesoTara": pesoTara,
          "pesoNeto": pesoNeto, "factorConversion": factorConversion, "pesoQuintales": pesoQuintales
        }];
      }

      //** Calcular Total de Pesajes
      function calcularTotalPesaje() {
        let pesajes = tablaPesaje.rows().data();
        let suma = 0;
        for (let i = 0; i < pesajes.length; i++) {
          suma += parseFloat(pesajes[i].pesoQuintales);
        }
        return suma.toFixed(2);
      }
    
      //** Limpiar todos los campos de la compra
      function limpiarCamposCompra() {
        $('#nro_cedula').val("");
        $("#nom_productor").val("");
        $("#productor").val("");
        productor = null;
        limpiarCamposCalculo();
        $("#totalPesajes").text("0.00");
        tablaPesaje.rows().remove().draw(false);
        $('#observacion').val("");
      }

      //** Limpiar los campos del Cálculo de Pesaje
      function limpiarCamposCalculo() {
        $('#peso_bruto').val("");
        $('#peso_tara').val("");
        $("#factor_conversion").val("default");
        $('#peso_neto').val("0");
        $('#peso_quintales').val("0.00");
      }
    });

  </script>

{% endblock javascripts %}